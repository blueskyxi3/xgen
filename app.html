<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合同管理系统</title>
    <!-- 加载 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义样式，模拟 Material Design 扁平化风格和确保响应式布局 */
        body { font-family: 'Inter', sans-serif; }
        .card { box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        /* 针对输入框的焦点样式 */
        .input-focus:focus { outline: 2px solid #3b82f6; border-color: #3b82f6; }
        .input-focus { transition: all 0.2s; }
        /* 主按钮样式 */
        .btn-primary { background-color: #3b82f6; color: white; transition: background-color 0.2s; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        /* 次按钮样式 */
        .btn-secondary { background-color: white; border: 1px solid #d1d5db; color: #374151; transition: background-color 0.2s; }
        .btn-secondary:hover:not(:disabled) { background-color: #f9fafb; }
        /* 模态框背景 */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        /* 状态标签样式 */
        .status-badge { display: inline-flex; align-items: center; padding: 2px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; cursor: help; }
        /* 日志时间线样式 */
        .timeline { position: relative; }
        .timeline-item { position: relative; padding-left: 20px; }
        .timeline-item:not(:last-child)::before { content: ''; position: absolute; left: 6px; top: 12px; bottom: 0; width: 2px; background-color: #e5e7eb; }
        .timeline-dot { position: absolute; left: 3px; top: 8px; width: 8px; height: 8px; border-radius: 50%; background-color: #9ca3af; z-index: 10; }
        .timeline-dot-active { background-color: #3b82f6; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-50 text-gray-900 font-sans p-4 md:p-8">
        <!-- JavaScript 将在这里渲染内容 -->
    </div>
    <div id="modals">
        <!-- 模态框和弹出窗口将在这里渲染 -->
    </div>

    <script>
        // --- 模拟数据和全局状态 ---

        const MOCK_TABLE_DATA = [
            { id: 'CON-2023001', type: '保密协议 (NDA)', status: '已完成', date: '2023-10-25' },
            { id: 'CON-2023002', type: '服务合同', status: '处理中', date: '2023-10-26' },
            { id: 'CON-2023003', type: '采购订单', status: '初始化', date: '2023-10-27' },
            { id: 'CON-2023004', type: '合作备忘录', status: '错误', date: '2023-10-24' },
            { id: 'CON-2023005', type: '租赁协议', status: '已完成', date: '2023-10-20' },
        ];

        const MOCK_AUDIT_DATA = {
            disclosing_party: "DIGI TELECOMMUNICATIONS SDN. BHD. 和 CELCOM MOBILE SDN BHD.（统称为\"Operators\"）",
            receiving_party: "CITIC Telecom International Limited（中信国际电讯有限公司）",
            party_country: "马来西亚",
            party_type: "供应商",
            contract_summary: "涉及IDD和集线器业务的外包",
            confidentiality_period: "自生效日期起五年，到期或终止后继续两年",
            arbitration_law: "第9(g)条:马来西亚法律管辖->马来西亚法院的专属管辖"
        };

        const STATUS_COLORS = {
            '初始化': 'bg-gray-100 text-gray-600',
            '处理中': 'bg-blue-100 text-blue-600',
            '已完成': 'bg-green-100 text-green-600',
            '错误': 'bg-red-100 text-red-600'
        };

        const STATE = {
            currentView: 'list',
            tableData: JSON.parse(JSON.stringify(MOCK_TABLE_DATA)), // 深拷贝初始数据
            selectedContract: null,
            filters: { status: '', id: '', type: '' }
        };

        const appContainer = document.getElementById('app');
        const modalsContainer = document.getElementById('modals');

        // 使用 Lucide SVG 图标的内联版本
        const icons = {
            search: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            upload: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899V20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5.1"/><path d="M12 2v10.1"/><path d="m16 6-4-4-4 4"/></svg>`,
            download: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`,
            fileCheck: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v6h6"/><path d="m9 15 2 2 4-4"/></svg>`,
            chevronLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>`,
            clock: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            checkCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>`,
        };

        /**
         * 核心渲染和导航
         */
        function navigateTo(view, data = null) {
            STATE.currentView = view;
            STATE.selectedContract = data;
            renderApp();
        }

        function renderApp() {
            // 清除之前的页面内容和所有弹出窗口
            appContainer.innerHTML = '';
            modalsContainer.innerHTML = '';

            switch (STATE.currentView) {
                case 'list':
                    renderListView();
                    break;
                case 'upload':
                    renderUploadView();
                    break;
                case 'audit':
                    renderAuditView();
                    break;
                default:
                    renderListView();
            }
        }

        // --- 模态框/自定义提示实现 (禁止使用 alert/confirm) ---

        /**
         * 显示一个自定义模态框，代替原生 alert/confirm
         * @param {string} message 要显示的消息
         * @param {'info'|'success'|'error'} type 模态框类型
         * @param {function} onConfirm 确认按钮点击后的回调函数
         */
        function showModal(message, type = 'info', onConfirm = () => {}) {
            const existingModal = document.getElementById('custom-modal');
            if (existingModal) existingModal.remove();

            const titleMap = { 'success': '操作成功', 'error': '操作失败', 'info': '提示信息' };
            const colorMap = { 'success': 'bg-green-500', 'error': 'bg-red-500', 'info': 'bg-blue-500' };
            const iconMap = { 'success': icons.checkCircle, 'error': icons.x, 'info': icons.clock };

            const modal = document.createElement('div');
            modal.id = 'custom-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-overlay transition-opacity duration-300';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm mx-4 transform scale-100 transition-transform duration-300">
                    <div class="p-4 flex items-center border-b border-gray-100">
                        <div class="p-2 rounded-full ${colorMap[type] || 'bg-gray-500'} text-white">
                            <span class="w-5 h-5">${iconMap[type] || icons.clock}</span>
                        </div>
                        <h3 class="ml-3 text-lg font-medium text-gray-900">${titleMap[type] || '提示'}</h3>
                    </div>
                    <div class="p-6 text-sm text-gray-700 whitespace-pre-wrap">
                        ${message}
                    </div>
                    <div class="p-4 border-t border-gray-100 flex justify-end">
                        <button id="modal-confirm" class="btn-primary px-4 py-2 rounded-md font-medium">
                            确定
                        </button>
                    </div>
                </div>
            `;

            modalsContainer.appendChild(modal);

            document.getElementById('modal-confirm').addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });
        }
        
        // --- 视图 1: 合同管理列表 ---

        function getFilteredData() {
            const { status, id, type } = STATE.filters;
            return STATE.tableData.filter(item => {
                return (
                    (status === '' || item.status === status) &&
                    (id === '' || item.id.toLowerCase().includes(id.toLowerCase())) &&
                    (type === '' || item.type.includes(type))
                );
            });
        }

        function renderLogPopup(e, contractId) {
            const rect = e.target.closest('td').getBoundingClientRect();
            const popup = document.createElement('div');
            popup.id = 'log-popup';
            popup.className = "absolute z-50 bg-white rounded-lg shadow-xl w-80 p-4 text-sm animate-in fade-in zoom-in-95 duration-200 border border-gray-200";
            popup.style.top = `${rect.bottom + window.scrollY + 5}px`;
            popup.style.left = `${rect.left + window.scrollX}px`;
            popup.style.transform = 'translateX(-50%)'; // 居中定位
            
            // 模拟后台接口 http://n8n.citictel.com/api/getProcessLog/{id}
            const logs = [
                { time: '2023-10-26 14:30:00', action: '系统自动归档', message: '文件已加密存储' },
                { time: '2023-10-26 10:15:00', action: '人工审核通过', message: '审核人: Admin' },
                { time: '2023-10-25 09:00:00', action: '合同上传', message: '源文件: contract_v1.pdf' },
            ];

            popup.innerHTML = `
                <div class="flex justify-between items-center mb-3 border-b pb-2">
                    <h3 class="font-semibold text-gray-800 flex items-center">
                        <span class="w-4 h-4 mr-2 text-blue-500">${icons.clock}</span>
                        处理日志 (${contractId})
                    </h3>
                    <button id="close-log-popup" class="text-gray-400 hover:text-gray-600"><span class="w-4 h-4">${icons.x}</span></button>
                </div>
                <div class="space-y-4 max-h-60 overflow-y-auto timeline">
                    ${logs.map((log, index) => `
                        <div class="timeline-item">
                            <div class="timeline-dot ${index === 0 ? 'bg-blue-500' : 'bg-gray-300'}"></div>
                            <div>
                                <p class="font-medium text-gray-800">${log.action}</p>
                                <p class="text-xs text-gray-500">${log.time}</p>
                                ${log.message ? `<p class="text-xs text-gray-600 mt-1 bg-gray-50 p-1.5 rounded">${log.message}</p>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            const existingPopup = document.getElementById('log-popup');
            if (existingPopup) existingPopup.remove();
            
            modalsContainer.appendChild(popup);
            
            // 添加关闭事件
            document.getElementById('close-log-popup').addEventListener('click', removeLogPopup);
        }

        function removeLogPopup() {
            const existingPopup = document.getElementById('log-popup');
            if (existingPopup) existingPopup.remove();
        }

        function handleFilterChange(key, value) {
            STATE.filters[key] = value;
            renderApp();
        }

        function handleTableAction(action, id) {
            if (action === 'delete') {
                showModal('确认删除该合同吗?', 'info', () => {
                    // Mock API: DELETE /api/contracts/{id}
                    STATE.tableData = STATE.tableData.filter(item => item.id !== id);
                    renderApp();
                });
            } else if (action === 'download') {
                // Mock API: GET /api/contracts/{id}/download
                showModal(`下载请求已发送: ID ${id}`, 'info');
            } else if (action === 'audit') {
                const contract = STATE.tableData.find(item => item.id === id);
                if (contract && contract.status === '已完成') {
                    navigateTo('audit', contract);
                }
            }
        }

        function renderListView() {
            const filteredData = getFilteredData();
            
            appContainer.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">合同管理</h1>
                        <p class="text-gray-500 text-sm mt-1">管理、查询及审核您的所有合同文件</p>
                    </div>

                    <!-- 查询区域 -->
                    <div class="card bg-white p-5">
                        <div class="flex flex-col md:flex-row gap-4 items-end">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 flex-1 w-full">
                                <div class="space-y-1">
                                    <label class="text-sm font-medium text-gray-700">合同编号</label>
                                    <div class="relative">
                                        <span class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">${icons.search}</span>
                                        <input id="filter-id" type="text" 
                                            class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-md input-focus focus:ring-blue-500 outline-none text-sm"
                                            placeholder="输入编号如 CON-2023..."
                                            value="${STATE.filters.id}"
                                        >
                                    </div>
                                </div>
                                
                                <div class="space-y-1">
                                    <label class="text-sm font-medium text-gray-700">合同类型</label>
                                    <input id="filter-type" type="text" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus focus:ring-blue-500 outline-none text-sm"
                                        placeholder="输入类型..."
                                        value="${STATE.filters.type}"
                                    >
                                </div>

                                <div class="space-y-1">
                                    <label class="text-sm font-medium text-gray-700">状态</label>
                                    <select id="filter-status"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus focus:ring-blue-500 outline-none text-sm bg-white"
                                    >
                                        <option value="">全部状态</option>
                                        <option value="初始化" ${STATE.filters.status === '初始化' ? 'selected' : ''}>初始化</option>
                                        <option value="处理中" ${STATE.filters.status === '处理中' ? 'selected' : ''}>处理中</option>
                                        <option value="已完成" ${STATE.filters.status === '已完成' ? 'selected' : ''}>已完成</option>
                                        <option value="错误" ${STATE.filters.status === '错误' ? 'selected' : ''}>错误</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button id="btn-upload" class="btn-primary flex items-center justify-center px-4 py-2 rounded-md font-medium shadow-sm w-full md:w-auto h-10">
                                <span class="w-5 h-5 mr-2">${icons.upload}</span>
                                上传合同
                            </button>
                        </div>
                    </div>

                    <!-- 表格区域 -->
                    <div class="card bg-white">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-600 font-medium border-b border-gray-200">
                                    <tr>
                                        <th class="px-6 py-3 whitespace-nowrap">编号</th>
                                        <th class="px-6 py-3 whitespace-nowrap">类型</th>
                                        <th class="px-6 py-3 whitespace-nowrap">状态</th>
                                        <th class="px-6 py-3 whitespace-nowrap">处理日期</th>
                                        <th class="px-6 py-3 text-right whitespace-nowrap">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="contract-table-body" class="divide-y divide-gray-100">
                                    ${filteredData.length > 0 ? filteredData.map(row => `
                                        <tr class="hover:bg-gray-50 transition-colors">
                                            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${row.id}</td>
                                            <td class="px-6 py-4 text-gray-600 whitespace-nowrap">${row.type}</td>
                                            <td class="px-6 py-4 relative">
                                                <span 
                                                    class="status-badge ${STATUS_COLORS[row.status] || 'bg-gray-100'}"
                                                    data-action="show-log"
                                                    data-id="${row.id}"
                                                >
                                                    ${row.status}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-gray-500 font-mono whitespace-nowrap">${row.date}</td>
                                            <td class="px-6 py-4 text-right whitespace-nowrap">
                                                <div class="flex justify-end gap-2">
                                                    <button 
                                                        class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                                        title="下载"
                                                        data-action="download"
                                                        data-id="${row.id}"
                                                    >
                                                        <span class="w-4 h-4">${icons.download}</span>
                                                    </button>
                                                    <button 
                                                        class="p-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                                                        title="删除"
                                                        data-action="delete"
                                                        data-id="${row.id}"
                                                    >
                                                        <span class="w-4 h-4">${icons.trash}</span>
                                                    </button>
                                                    <button 
                                                        class="p-1.5 rounded transition-colors flex items-center gap-1 ${
                                                            row.status === '已完成' 
                                                                ? 'text-blue-600 hover:bg-blue-50' 
                                                                : 'text-gray-300 cursor-not-allowed'
                                                        }"
                                                        title="${row.status === '已完成' ? "审核" : "仅已完成可审核"}"
                                                        data-action="audit"
                                                        data-id="${row.id}"
                                                        ${row.status !== '已完成' ? 'disabled' : ''}
                                                    >
                                                        <span class="w-4 h-4">${icons.fileCheck}</span>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="5" class="px-6 py-12 text-center text-gray-400">
                                                没有找到符合条件的合同
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // 附加事件监听器
            document.getElementById('filter-id').addEventListener('input', (e) => handleFilterChange('id', e.target.value));
            document.getElementById('filter-type').addEventListener('input', (e) => handleFilterChange('type', e.target.value));
            document.getElementById('filter-status').addEventListener('change', (e) => handleFilterChange('status', e.target.value));
            document.getElementById('btn-upload').addEventListener('click', () => navigateTo('upload'));

            // 表格事件委托：处理操作按钮
            appContainer.querySelector('tbody').addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action]');
                if (button && !button.disabled) {
                    handleTableAction(button.dataset.action, button.dataset.id);
                }
            });

            // 表格事件委托：处理日志弹出窗口 (悬浮)
            let logTimeout;
            const tableBody = document.getElementById('contract-table-body');
            
            tableBody.addEventListener('mouseover', (e) => {
                const target = e.target.closest('.status-badge[data-action="show-log"]');
                if (target) {
                    clearTimeout(logTimeout);
                    // 延迟显示弹出窗口
                    logTimeout = setTimeout(() => {
                        renderLogPopup(e, target.dataset.id);
                    }, 300); 
                }
            });

            tableBody.addEventListener('mouseout', (e) => {
                const target = e.target.closest('.status-badge[data-action="show-log"]');
                if (target) {
                    clearTimeout(logTimeout);
                    // 延迟隐藏弹出窗口，给用户移动鼠标到弹窗的时间
                    logTimeout = setTimeout(removeLogPopup, 500); 
                }
            });

            // 阻止鼠标移到弹窗上时弹窗消失
            modalsContainer.addEventListener('mouseover', (e) => {
                if (e.target.closest('#log-popup')) {
                    clearTimeout(logTimeout);
                }
            });

            modalsContainer.addEventListener('mouseout', (e) => {
                if (e.target.closest('#log-popup')) {
                    logTimeout = setTimeout(removeLogPopup, 500);
                }
            });
        }

        // --- 视图 2: 合同上传界面 ---

        function handleUploadSubmit(e) {
            e.preventDefault();
            const fileInput = document.getElementById('file-input');
            const templateSelect = document.getElementById('template-select');
            
            if (fileInput.files.length === 0) {
                showModal('请先选择文件', 'info');
                return;
            }

            const file = fileInput.files[0];
            const template = templateSelect.options[templateSelect.selectedIndex].text;
            
            // 模拟后台 API 调用，成功后返回列表并刷新
            
            showModal(`合同 ${file.name} 上传成功！`, 'success', () => {
                // 执行一次合同查询操作 (更新状态)
                STATE.tableData.unshift({
                    id: `CON-${Math.floor(Math.random() * 90000) + 10000}`,
                    type: template.includes('默认') ? '保密协议 (NDA)' : template,
                    status: '初始化',
                    date: new Date().toISOString().split('T')[0]
                });
                navigateTo('list');
            });
        }

        function renderUploadView() {
            appContainer.innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <div class="mb-6">
                        <button id="btn-back-list" class="flex items-center text-gray-500 hover:text-blue-600 mb-2 transition-colors">
                            <span class="w-4 h-4 mr-1">${icons.chevronLeft}</span> 返回列表
                        </button>
                        <h1 class="text-2xl font-bold text-gray-800">上传新合同</h1>
                    </div>

                    <div class="card bg-white p-8">
                        <form id="upload-form" class="space-y-6">
                            
                            <div class="space-y-2">
                                <label for="template-select" class="block text-sm font-medium text-gray-700">合同模板</label>
                                <select id="template-select"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus focus:ring-blue-500 outline-none bg-white"
                                >
                                    <option value="nda">保密合同 - 默认</option>
                                    <option value="服务合同">服务合同</option>
                                    <option value="采购合同">采购合同</option>
                                    <option value="合作备忘录">合作备忘录</option>
                                </select>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">
                                    合同文件 <span class="text-red-500">*</span>
                                </label>
                                <div id="drop-area"
                                    class="border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer border-gray-300 hover:border-gray-400"
                                >
                                    <input id="file-input" type="file" class="hidden" accept=".pdf,.doc,.docx" />
                                    <div class="flex flex-col items-center gap-2">
                                        <div class="p-3 bg-blue-50 text-blue-600 rounded-full">
                                            <span class="w-6 h-6">${icons.upload}</span>
                                        </div>
                                        <div id="file-info" class="text-sm text-gray-500">
                                            <p class="font-medium text-gray-700">点击上传 或 拖拽文件至此</p>
                                            <p class="mt-1 text-xs text-gray-400">支持 PDF, Word 文档</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="pt-4 flex gap-3">
                                <button type="button" id="btn-cancel-upload" class="btn-secondary flex-1 px-4 py-2 rounded-md font-medium shadow-sm">
                                    取消
                                </button>
                                <button type="submit" id="btn-submit-upload" disabled 
                                    class="btn-primary flex-1 px-4 py-2 rounded-md font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                    提交
                                </button>
                            </div>

                        </form>
                    </div>
                </div>
            `;

            // 附加事件监听器
            document.getElementById('btn-back-list').addEventListener('click', () => navigateTo('list'));
            document.getElementById('btn-cancel-upload').addEventListener('click', () => navigateTo('list'));
            document.getElementById('upload-form').addEventListener('submit', handleUploadSubmit);

            const fileInput = document.getElementById('file-input');
            const dropArea = document.getElementById('drop-area');
            const fileInfo = document.getElementById('file-info');
            const submitBtn = document.getElementById('btn-submit-upload');

            function updateFileInfo(file) {
                if (file) {
                    fileInfo.innerHTML = `
                        <p class="font-medium text-gray-800">${file.name}</p>
                        <p class="text-gray-500">(${(file.size / 1024 / 1024).toFixed(2)} MB)</p>
                    `;
                    submitBtn.disabled = false;
                } else {
                    fileInfo.innerHTML = `
                        <p class="font-medium text-gray-700">点击上传 或 拖拽文件至此</p>
                        <p class="mt-1 text-xs text-gray-400">支持 PDF, Word 文档</p>
                    `;
                    submitBtn.disabled = true;
                }
            }

            fileInput.addEventListener('change', (e) => updateFileInfo(e.target.files[0]));
            dropArea.addEventListener('click', () => fileInput.click());

            // 拖放逻辑
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('border-blue-500', 'bg-blue-50'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('border-blue-500', 'bg-blue-50'));
            });

            dropArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                if (file) {
                    fileInput.files = dt.files;
                    updateFileInfo(file);
                }
            });
        }

        // --- 视图 3: 审核界面 ---

        function renderAuditView() {
            const contract = STATE.selectedContract;
            if (!contract) return navigateTo('list');

            // 组装初始表单数据
            const initialFormData = {
                id: contract.id,
                partyNames: `${MOCK_AUDIT_DATA.disclosing_party}\n${MOCK_AUDIT_DATA.receiving_party}`,
                country: MOCK_AUDIT_DATA.party_country,
                designation: MOCK_AUDIT_DATA.party_type,
                isNew: "新", // 默认/模拟值
                description: MOCK_AUDIT_DATA.contract_summary,
                period: MOCK_AUDIT_DATA.confidentiality_period,
                companySearch: "无", // 默认/模拟值
                sanctionCheck: "截至 2025年11月10日，未受制裁", // 默认/模拟值
                accountManager: "Kenneth Mok", // 默认/模拟值
                isStandard: "是", // 默认/模拟值
                limitationLiability: MOCK_AUDIT_DATA.arbitration_law
            };

            // 辅助函数：渲染审核行
            function renderAuditRow(label, key, isTextarea = false, defaultValue) {
                const value = initialFormData[key] || defaultValue;
                
                let inputField;
                if (isTextarea) {
                    inputField = `<textarea 
                        id="audit-${key}"
                        class="w-full h-full min-h-[80px] p-2 border border-transparent hover:border-gray-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded outline-none resize-y text-sm text-gray-800"
                    >${value}</textarea>`;
                } else {
                    inputField = `<input 
                        type="text" 
                        id="audit-${key}"
                        class="w-full p-2 border border-transparent hover:border-gray-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded outline-none text-sm text-gray-800"
                        value="${value.replace(/"/g, '&quot;')}"
                    />`;
                }

                return `
                    <div class="grid grid-cols-1 md:grid-cols-[250px_1fr] border-b border-gray-200 last:border-b-0">
                        <div class="bg-gray-50 p-4 font-medium text-sm text-gray-700 border-r border-gray-200 flex items-center">
                            ${label}
                        </div>
                        <div class="p-2">
                            ${inputField}
                        </div>
                    </div>
                `;
            }

            appContainer.innerHTML = `
                <div class="max-w-5xl mx-auto pb-10">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <button id="btn-back-list-audit" class="flex items-center text-gray-500 hover:text-blue-600 mb-2 transition-colors">
                                <span class="w-4 h-4 mr-1">${icons.chevronLeft}</span> 返回列表
                            </button>
                            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                合同审核 
                                <span class="text-base font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                    ${contract.id}
                                </span>
                            </h1>
                        </div>
                        <div class="flex gap-3">
                            <button id="btn-reject" class="btn-secondary px-4 py-2 rounded-md font-medium shadow-sm">驳回</button>
                            <button id="btn-approve" class="btn-primary flex items-center px-4 py-2 rounded-md font-medium shadow-sm">
                                <span class="w-4 h-4 mr-2">${icons.checkCircle}</span>
                                通过审核
                            </button>
                        </div>
                    </div>

                    <div class="card bg-white overflow-hidden">
                        <div class="bg-gray-100 px-6 py-3 border-b border-gray-200 font-bold text-gray-700 uppercase text-sm tracking-wide">
                            Contract Summary Section
                        </div>
                        <form id="audit-form">
                            <div class="flex flex-col border-b border-gray-200">
                                ${renderAuditRow("1. Name of the parties to the contract", "partyNames", true)}
                                ${renderAuditRow("2. Counterparty's country/ region", "country")}
                                ${renderAuditRow("3. Counterparty's designation", "designation")}
                                ${renderAuditRow("4. Is the counterparty a new/existing contracting party? If existing, is it a renewal?", "isNew")}
                                ${renderAuditRow("5. Brief service description of this contract", "description", true)}
                                
                                <!-- Contract Period Complex Row -->
                                <div class="grid grid-cols-1 md:grid-cols-[250px_1fr] border-b border-gray-200">
                                    <div class="bg-gray-50 p-4 font-medium text-sm text-gray-700 border-r border-gray-200 flex items-center">
                                        6. Contract Period
                                    </div>
                                    <div class="p-0">
                                        <div class="grid grid-cols-[1fr_1fr] border-b border-gray-100">
                                            <div class="p-2 border-r border-gray-100 text-gray-500 text-xs font-medium uppercase">Any effective date?</div>
                                            <div class="p-2 text-sm">待定</div>
                                        </div>
                                        <div class="grid grid-cols-[1fr_1fr] border-b border-gray-100">
                                            <div class="p-2 border-r border-gray-100 text-gray-500 text-xs font-medium uppercase">Effective date:</div>
                                            <div class="p-2 text-sm">不适用</div>
                                        </div>
                                        <div class="border-t border-gray-100 p-2">
                                            <span class="text-gray-500 text-xs font-medium uppercase block mb-1">Additional information / Period:</span>
                                            <textarea 
                                                id="audit-period"
                                                class="w-full p-2 border border-gray-200 rounded text-sm focus:border-blue-500 outline-none"
                                            >${initialFormData.period}</textarea>
                                        </div>
                                    </div>
                                </div>

                                ${renderAuditRow("7. Company search", "companySearch")}
                                ${renderAuditRow("8. Sanction check", "sanctionCheck")}
                                ${renderAuditRow("9. Account Manager", "accountManager")}
                            </div>

                            <div class="bg-gray-100 px-6 py-3 border-b border-gray-200 font-bold text-gray-700 uppercase text-sm tracking-wide">
                                Contract Clause
                            </div>
                            <div>
                                ${renderAuditRow("10. Is this a standard CITIC template with no modifications?", "isStandard")}
                                ${renderAuditRow("11. Limitation of liability (Mapped from Arbitration)", "limitationLiability", true)}
                            </div>
                        </form>
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-400 text-center">
                        * 右侧字段可编辑。数据已根据后台接口自动填充。
                    </div>
                </div>
            `;

            // 附加事件监听器
            document.getElementById('btn-back-list-audit').addEventListener('click', () => navigateTo('list'));
            document.getElementById('btn-reject').addEventListener('click', () => handleAuditAction('reject', contract.id));
            document.getElementById('btn-approve').addEventListener('click', () => handleAuditAction('approve', contract.id));
        }

        function handleAuditAction(action, id) {
            const message = action === 'approve' ? '通过' : '驳回';
            
            // 找到合同并更新状态
            const contract = STATE.tableData.find(c => c.id === id);
            if (contract) {
                // 模拟状态流转: 通过 -> 处理中；驳回 -> 错误
                contract.status = action === 'approve' ? '处理中' : '错误';
            }

            showModal(`合同 ${id} 已${message}。`, action === 'approve' ? 'success' : 'error', () => {
                navigateTo('list');
            });
        }


        // --- 初始化 ---
        window.onload = function() {
            renderApp();
        };
    </script>
</body>
</html>